name: cloud-sql-proxy
runtime: yaml
description: Proxy for managed Cloud SQL server

variables:
  appLabels:
    app.kubernetes.io/name: ${pulumi.project}-${pulumi.stack}

resources:
  namespace:
    type: kubernetes:core/v1:Namespace
    properties:
      metadata:
        name: ${pulumi.project}-${pulumi.stack}

  serviceAccount:
    type: kubernetes:core/v1:ServiceAccount
    properties:
      metadata:
        name: ${pulumi.project}-${pulumi.stack}
        namespace: ${namespace.metadata.name}
        annotations:
          'iam.gke.io/gcp-service-account': ${database:serviceAccountEmail}

  serviceAccountIamBinding:
    type: gcp:serviceAccount:IAMMember
    properties:
      serviceAccountId: ${database:serviceAccountId}
      role: roles/iam.workloadIdentityUser
      member: serviceAccount:${gcp:project}.svc.id.goog[${namespace.metadata.name}/${serviceAccount.metadata.name}]

  service:
    type: kubernetes:core/v1:Service
    properties:
      metadata:
        name: ${pulumi.project}-${pulumi.stack}
        namespace: ${namespace.metadata.name}
      spec:
        selector: ${appLabels}
        ports:
          - port: 5432
            targetPort: 5432

  proxy:
    type: kubernetes:apps/v1:Deployment
    properties:
      metadata:
        name: ${pulumi.project}-${pulumi.stack}
        namespace: ${namespace.metadata.name}
        annotations:
          pulumi.com/skipAwait: 'true'
          pulumi.com/patchForce: 'true'
      spec:
        replicas: 1
        selector:
          matchLabels: ${appLabels}
        template:
          metadata:
            labels: ${appLabels}
          spec:
            serviceAccountName: ${serviceAccount.metadata.name}
            nodeSelector:
              'iam.gke.io/gke-metadata-server-enabled': 'true'
            containers:
              - name: cloud-sql-proxy
                image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
                args:
                  - --structured-logs=true
                  - --port=5432
                  - ${database:connectionName}
                securityContext:
                  runAsNonRoot: true
